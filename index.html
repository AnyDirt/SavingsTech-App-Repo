<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visa Merchant Finder</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 400px; margin: 0 auto; padding: 20px; text-align: center; }
    button { background: #1a73e8; color: white; border: none; padding: 15px; font-size: 18px; border-radius: 5px; width: 100%; margin: 20px 0; cursor: pointer; }
    button:hover { background: #1557b0; }
    #result { margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px; text-align: left; display: none; }
    .loading { color: #666; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>Find Nearby Visa Merchants</h1>
  <p>Click below to use your phone's location 0122pm.</p>
  <button id="locateBtn">Get My Location & Search</button>
  <div id="status"></div>
  <div id="result"></div>

  <script>
    const locateBtn = document.getElementById('locateBtn');
    const status = document.getElementById('status');
    const result = document.getElementById('result');

    locateBtn.addEventListener('click', getLocation);

    function getLocation() {
      status.innerHTML = '<p class="loading">Requesting location...</p>';
      result.style.display = 'none';
      if (!navigator.geolocation) {
        showError('Geolocation not supported.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        success,
        error,
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 } // Mobile-optimized options
      );
    }

    function success(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      status.innerHTML = '<p class="loading">Searching for nearby merchants...</p>';
      searchMerchants(lat, lng);
    }

    function error(err) {
      let msg = 'Error getting location: ';
      switch (err.code) {
        case err.PERMISSION_DENIED: msg += 'Permission denied.'; break;
        case err.POSITION_UNAVAILABLE: msg += 'Location unavailable.'; break;
        case err.TIMEOUT: msg += 'Request timed out.'; break;
        default: msg += 'Unknown error.';
      }
      showError(msg);
    }


    async function searchMerchants(lat, lng) {
      try {
        const response = await fetch('/.netlify/functions/search-merchants', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ latitude: lat, longitude: lng, radius: 20 })
        });
        const data = await response.json();
        if (!response.ok || data.error) {
          throw new Error(data.error || `HTTP error: ${response.status}`);
        }
        if (!data.merchants || data.merchants.length === 0) {
          throw new Error('No merchants found within 60 meters. Try increasing search radius.');
        }

        displayResult(data.merchants);

      } catch (err) {
        console.error('Detailed Error:', err);
        showError(`Failed to fetch merchants: ${err.message}`);
      }
    }

    function findClosestMerchant(merchants, userLat, userLng) { // Haversine if API doesn't sort
      return merchants.reduce((closest, merchant) => {
        const dist = haversine(userLat, userLng, merchant.latitude, merchant.longitude);
        return !closest || dist < closest.distance ? { ...merchant, distance: dist } : closest;
      }, null);
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }


    function displayResult(merchants) {
      status.innerHTML = '';
  
      const nearest5 = merchants.slice(0, 5);
  
      result.innerHTML = '<h3>5 Nearest Merchants:</h3>' + 
        nearest5.map((merchant, index) => `
          <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #ddd;">
            <h4 style="margin: 5px 0;">${index + 1}. ${merchant.merchantName}</h4>
            <p style="margin: 5px 0;"><strong>Address:</strong> ${merchant.address.line1}</p>
            <p style="margin: 5px 0;"><strong>Category:</strong> ${merchant.address.categoryGroup}${merchant.address.categoryDesc ? ' -- ' + merchant.address.categoryDesc : ''}</p>
            <p style="margin: 5px 0;"><strong>Distance:</strong> ${merchant.distance.toFixed(2)} mi</p>
            <p style="margin: 5px 0;"><strong>Phone:</strong> ${merchant.phoneNumber}</p>
          </div>
        `).join('');
  
      result.style.display = 'block';
    }


    function showError(msg) {
      status.innerHTML = `<p class="error">${msg}</p>`;
    }
  </script>
</body>
</html>