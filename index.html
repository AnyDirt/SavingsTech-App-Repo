<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="apple-touch-icon" href="/SavingsTech Icon png.png">
    <title>SavingsTech</title>
    <script src="https://unpkg.com/@ericblade/quagga2@v0.0.10/dist/quagga.min.js"></script>

<style>
/* body * {
    display: none !important;
}
body:before {
    content: "App Under Maintenance - Please Try Again Later";
    display: block !important;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 18px;
    font-weight: bold;
    background: white;
    padding: 20px;
    z-index: 99999;
}
*/
</style>


<style id="maintenanceStyle">
body * {
    display: none !important;
}
body:before {
    content: "Checking location...";
    display: block !important;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 18px;
    font-weight: bold;
    background: white;
    padding: 20px;
    z-index: 99999;
    text-align: center;
}
</style>

<script>
// Check geolocation and app availability
function checkLocationAndActivate() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                // Check if location is within allowed bounds
                if (lat >= 40 && lat <= 44 && lon >= -75 && lon <= -71) {
                    // Location is valid - remove maintenance mode
                    const maintenanceStyle = document.getElementById('maintenanceStyle');
                    if (maintenanceStyle) {
                        maintenanceStyle.remove();
                    }
                } else {
                    // Outside service area
                    showMessage("Sorry, service is not available in your area. *SavingsTech*");
                }
            },
            function(error) {
                // Geolocation failed
                showMessage("Location access required. Please enable location services and refresh.");
            },
            {
                timeout: 10000,
                enableHighAccuracy: true
            }
        );
    } else {
        showMessage("Geolocation not supported by this browser");
    }
}

function showMessage(message) {
    const style = document.getElementById('maintenanceStyle');
    if (style) {
        style.innerHTML = `
            body * { display: none !important; }
            body:before { 
                content: "${message}";
                display: block !important;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 18px;
                font-weight: bold;
                background: white;
                padding: 20px;
                z-index: 99999;
                text-align: center;
            }
        `;
    }
}

// Run the location check when page loads
checkLocationAndActivate();

</script>


    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 40px;
        }
        .logo {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 140px;
        }
        .menu {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 66px;
            cursor: pointer;
            text-align: center;
        }
        .menu div {
            width: 30px;
            height: 5px;
            background-color: gray;
            margin: 6px auto;
        }
        .menu span {
            display: block;
            color: gray;
            font-size: 12px;
            margin-top: -5px;
        }
        .menu-dropdown {
            display: none;
            position: absolute;
            top: 60px;
            right: 10px;
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        button {
            background-color: #0070C0;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            display: block;
            margin: 10px auto;
        }
        button:disabled {
            background-color: gray;
            cursor: not-allowed;
        }
        .profile-setup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 90%;
            height: 90%;
            background: white;
            z-index: 1000;
            overflow-y: auto;
            padding: 30px 10px 10px 10px;
            overflow-x: visible;
        }
        .form-section {
            margin-bottom: 15px;
        }
        select, input[type="text"] {
            width: 80%;
            padding: 8px;
            font-size: 16px;
            margin: 5px auto;
        }
        .checkbox-group {
            text-align: left;
            margin-left: 10%;
            margin-right: 10%;
        }
        .checkbox-columns {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        .checkbox-column {
            flex: 1;
        }
        .mobile-box {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            width: 90%;
            margin-left: auto;
            margin-right: auto;
            background-color: #f9f9f9;
            overflow: visible;
            position: relative;
        }
        #profileSetupScreen h2 {
            margin-top: 0;
            font-size: 16px;
        }
       .vehicle-year, .vehicle-make, .vehicle-model {
            width: 80%;
            padding: 8px;
            font-size: 16px;
            margin: 5px auto;
            display: block;
        }
        #output {
            margin-top: 20px;
            font-size: 18px;
        }
        #getPlaceButton {
            display: none;
            text-align: center;
        }
        #scannerContainer {
            display: none;
            margin-top: 15px;
        }
        #scannerPreview {
            width: 100%;
            max-width: 400px;
            margin: auto;
            border: 1px solid #ccc;
        }
        #scannerPreview video {
            position: relative;
            display: block;
            margin: 0 auto;
            width: 100% !important;
            height: auto !important;
            max-width: 100%;
        }
        #recallResult {
            margin-top: 15px;
            font-size: 16px;
            font-weight: bold;
        }
        #maxAlertsScreen {
            display: none;
            text-align: left;
            padding: 0px;
        }
        .product-display {
            display: flex;
            align-items: flex-start;
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .product-image {
            width: 80px;
            height: 80px;
            margin-right: 15px;
            object-fit: cover;
        }
        .product-details {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <audio id="beepSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
    <img src="SavingsTechpng.png" alt="App Logo" class="logo">

    <div class="menu" onclick="toggleMenu()">
        <div></div>
        <div></div>
        <div></div>
        <span>Menu</span>
    </div>

    <div class="menu-dropdown" id="menuDropdown">
        <button onclick="forgetPhoneNumber(); document.getElementById('menuDropdown').style.display='none';" style="width: 160px; font-size: 13px;">Login with Mobile Number</button>
        <button onclick="registerCreditCards(); document.getElementById('menuDropdown').style.display='none';" style="width: 160px; font-size: 13px;">Enter Credit Cards By Program Name</button>
        <button onclick="navigateTo('profileSetup'); document.getElementById('menuDropdown').style.display='none';" style="width: 160px; font-size: 13px;">Set Up Profile for Safety Alerts</button>
        <button onclick="shareApp(); document.getElementById('menuDropdown').style.display='none';" style="width: 160px; font-size: 12.5px;">Share App with Neighbors & Friends</button>
        <button id="adminPanelButton" onclick="showAdminPanel(); document.getElementById('menuDropdown').style.display='none';" style="width: 160px; font-size: 13px; display: none;">Admin Panel</button>
    </div>

    <h1 id="nearestPlaceHeading" style="font-size: 20px; display: none; margin-top: 0px;">Max Rewards</h1>

    <div id="phoneEntry" style="margin-top: 50px;">
        <p>Enter your mobile number to start:</p>
        <input type="tel" id="phoneNumber" placeholder="Enter phone number">
        <button onclick="savePhoneNumber()">Submit</button>
    </div>

    <button id="getPlaceButton" onclick="getLocation()" style="margin-top: -10px;">Get Merchant</button>
    <p id="output" style="font-size: 14px; display: none;">Press button to get merchant and find your top card for rewards and offers 0911pm</p>
    <p id="nearestPlace" style="margin-top: -5px;"></p>
    <img id="rewardCards" src="" alt="Reward Cards" style="display: none; width: 100%; max-width: 120px; margin: 20px auto;">

    <div id="insurancePromo" style="display: none; margin-top: 40px;">
      <p id="promoMessage" style="font-size: 14px; font-weight: bold; color: #0070C0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;"></p>
      <p id="promoSubMessage" style="font-size: 13px; color: #333; font-style: italic; margin-top: -10px;"></p>
      <a id="promoButton" href="#" target="_blank" style="text-decoration: none;">
        <button style="margin-top: 10px;">Learn More</button>
      </a>
    </div>

    <script>

    document.addEventListener("DOMContentLoaded", function() {
        // Check for shared link tracking parameters
        const urlParams = new URLSearchParams(window.location.search);
        const referrer = urlParams.get('ref');
        const shareId = urlParams.get('sid');
    
        if (referrer && shareId) {
            logShareVisit(referrer, shareId);
            // Clean up URL to remove tracking parameters
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    
        // Existing login state check
        if (localStorage.getItem("userPhoneNumber")) {
            document.getElementById("phoneEntry").style.display = "none";
            document.getElementById("getPlaceButton").style.display = "block";
            document.getElementById("nearestPlaceHeading").style.display = "block";
            document.getElementById("output").style.display = "block";
        }
    
        // Initialize vehicle dropdowns immediately when page loads
        initializeVehicleDropdownsOnLoad();
    });


    function checkAdminAccess() {
        // Define multiple admin phone numbers
        const ADMIN_PHONES = ["+18607163323", "8607163323", "+1555123456"];
    
        const userPhone = localStorage.getItem("userPhoneNumber");
        const adminButton = document.getElementById("adminPanelButton");
    
        if (adminButton && ADMIN_PHONES.includes(userPhone)) {
            adminButton.style.display = "block";
        } else if (adminButton) {
            adminButton.style.display = "none";
        }
    }

    // Call this function when menu is opened
    function toggleMenu() {
        let menu = document.getElementById("menuDropdown");
        if (menu.style.display === "block") {
            menu.style.display = "none";
        } else {
            checkAdminAccess(); // Check admin access before showing menu
            menu.style.display = "block";
        }
    }


        function initializeVehicleDropdownsOnLoad() {
            // Populate year dropdowns
            const currentYear = new Date().getFullYear();
            const yearSelects = document.querySelectorAll('.vehicle-year');
    
            yearSelects.forEach(select => {
                for (let year = currentYear; year >= 1980; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    select.appendChild(option);
                }
            });

            // Populate make dropdowns
            const makes = ['Acura', 'Audi', 'BMW', 'Buick', 'Cadillac', 'Chevrolet', 'Chrysler', 'Dodge', 'Ford', 'GMC', 'Honda', 'Hyundai', 'Jeep', 'Kia', 'Lexus', 'Mazda', 'Mercedes-Benz', 'Nissan', 'Subaru', 'Tesla', 'Toyota', 'Volkswagen'];
    
            const makeSelects = document.querySelectorAll('.vehicle-make');
            makeSelects.forEach(select => {
                makes.forEach(make => {
                    const option = document.createElement('option');
                    option.value = make;
                    option.textContent = make;
                    select.appendChild(option);
                });
            });
        }

        function savePhoneNumber() {
            let phoneNumber = document.getElementById("phoneNumber").value;
            if (phoneNumber) {
                localStorage.setItem("userPhoneNumber", phoneNumber);
                document.getElementById("phoneEntry").style.display = "none";
                document.getElementById("getPlaceButton").style.display = "block";
                document.getElementById("nearestPlaceHeading").style.display = "block";
                document.getElementById("output").style.display = "block";
            } else {
                alert("Please enter a valid phone number.");
            }
        }

        function forgetPhoneNumber() {
            localStorage.removeItem("userPhoneNumber");
            location.reload();
        }


function registerCreditCards() {
    const formContainer = document.createElement("div");
    formContainer.innerHTML = `
        <div id="cardForm" style="position: fixed; top: 20%; left: 50%; transform: translate(-50%, -20%); background: #fff; padding: 20px; border: 1px solid #ccc; box-shadow: 2px 2px 10px rgba(0,0,0,0.3); z-index: 9999;">
            <h3 style="margin-top: 0;">Card Entry ${localStorage.getItem('registeredCreditCards') ? JSON.parse(localStorage.getItem('registeredCreditCards')).length + 1 : 1} of 5</h3>
            <label>Bank Name:<br>
                <input list="bankOptions" id="bankName" placeholder="Start typing...">
                <datalist id="bankOptions">
                    <option value="Chase">
                    <option value="American Express">
                    <option value="Capital One">
                    <option value="Citi">
                    <option value="Bank of America">
                    <option value="Wells Fargo">
                    <option value="Discover">
                    <option value="Barclays">
                    <option value="US Bank">
                    <option value="PNC">
                </datalist>
            </label><br><br>
            <label>Credit Card Program:<br>
                <input type="text" id="cardProgram" placeholder="Enter Program Name">
            </label><br><br>
            <button onclick="submitCardForm()" style="width: 80px; font-size: 13px; padding: 4px 8px; margin: 2px auto 6px auto;">Save</button>
            <button onclick="closeCardForm()" style="width: 80px; font-size: 13px; padding: 4px 8px; margin: 12px auto 4px auto;">Cancel</button>
        <div id="savedCardsSummary" style="text-align: left; font-size: 14px; margin-top: 15px;"></div>
</div>`;
    document.body.appendChild(formContainer);
    updateSavedCardsSummary(JSON.parse(localStorage.getItem("registeredCreditCards")) || []);
}

function submitCardForm() {
    const bank = document.getElementById("bankName").value;
    const program = document.getElementById("cardProgram").value;

    if (!bank || !program) {
        alert("Please fill out all fields.");
        return;
    }

    let cards = JSON.parse(localStorage.getItem("registeredCreditCards")) || [];
    if (cards.length >= 5) {
        alert("Maximum of 5 cards allowed.");
        return;
    }

    cards.push({ bank, program });
    localStorage.setItem("registeredCreditCards", JSON.stringify(cards));
    updateSavedCardsSummary(cards);
    alert("Credit Card Saved Successfully");
    closeCardForm();
}


function updateSavedCardsSummary(cards) {
    const summaryDiv = document.getElementById("savedCardsSummary");
    if (!summaryDiv) return;
    if (!cards || cards.length === 0) {
        summaryDiv.innerHTML = "";
        return;
    }
    let html = "<strong>Saved Cards:</strong><ul style='padding-left: 0; list-style: none;'>";
    cards.forEach((card, i) => {
        html += `<li style='display: flex; justify-content: space-between; align-items: center;'><span>(${i + 1}) ${card.bank} – ${card.program}</span><span style='display: flex; gap: 6px;'><button onclick="editCard(${i})" style='font-size: 11px; padding: 2px 6px;'>Edit</button><button onclick="removeCard(${i})" style='font-size: 11px; padding: 2px 6px;'>Remove</button></span></li>`;
    });
    html += "</ul>";
    summaryDiv.innerHTML = html;
}

function removeCard(index) {
    let cards = JSON.parse(localStorage.getItem("registeredCreditCards")) || [];
    cards.splice(index, 1);
    localStorage.setItem("registeredCreditCards", JSON.stringify(cards));
    updateSavedCardsSummary(cards);
}

function editCard(index) {
    let cards = JSON.parse(localStorage.getItem("registeredCreditCards")) || [];
    const card = cards[index];
    if (!card) return;

    const form = document.getElementById("cardForm");
    if (form) form.remove();

    const formContainer = document.createElement("div");
    formContainer.innerHTML = `
        <div id="cardForm" style="position: fixed; top: 20%; left: 50%; transform: translate(-50%, -20%); background: #fff; padding: 20px; border: 1px solid #ccc; box-shadow: 2px 2px 10px rgba(0,0,0,0.3); z-index: 9999;">
            <h3 style="margin-top: 0;">Edit Card ${index + 1}</h3>
            <label>Bank Name:<br>
                <input list="bankOptions" id="bankName" value="${card.bank}" placeholder="Start typing...">
                <datalist id="bankOptions">
                    <option value="Chase">
                    <option value="American Express">
                    <option value="Capital One">
                    <option value="Citi">
                    <option value="Bank of America">
                    <option value="Wells Fargo">
                    <option value="Discover">
                    <option value="Barclays">
                    <option value="US Bank">
                    <option value="PNC">
                </datalist>
            </label><br><br>
            <label>Credit Card Program:<br>
                <input type="text" id="cardProgram" value="${card.program}" placeholder="Enter Program Name">
            </label><br><br>
            <button onclick="updateCard(${index})" style="width: 80px; font-size: 13px; padding: 2px 6px; margin: 0px auto 6px auto;">Update</button>
            <button onclick="closeCardForm()" style="width: 80px; font-size: 13px; padding: 2px 6px; margin: 12px auto 4px auto;">Cancel</button>
        </div>`;
    document.body.appendChild(formContainer);
}

function updateCard(index) {
    let cards = JSON.parse(localStorage.getItem("registeredCreditCards")) || [];
    const bank = document.getElementById("bankName").value;
    const program = document.getElementById("cardProgram").value;
    if (!bank || !program) {
        alert("Please fill out all fields.");
        return;
    }
    cards[index] = { bank, program };
    localStorage.setItem("registeredCreditCards", JSON.stringify(cards));
    updateSavedCardsSummary(cards);
    closeCardForm();
}

function closeCardForm() {
    const form = document.getElementById("cardForm");
    if (form) form.remove();
    document.getElementById("menuDropdown").style.display = "none";
}


        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        let latitude = position.coords.latitude;
                        let longitude = position.coords.longitude;
                        fetchNearestPlace(latitude, longitude);
                    },
                    function(error) {
                        document.getElementById("output").innerText = "Error: " + error.message;
                    }
                );
            } else {
                document.getElementById("output").innerText = "Geolocation is not supported by this browser.";
            }
        }


// Category mapping from fsq_category_id to old integer IDs
const CATEGORY_MAPPING = {
    "4d4b7104d754a06370d81259": 10000, "4bf58dd8d48988d182941735": 10001, "5109983191d435c0d71c2bb1": 10002, "4fceea171983d5d06c3e9823": 10003, "4bf58dd8d48988d1e1931735": 10004, "4bf58dd8d48988d1e2931735": 10005, "63be6904847c3692a84b9b20": 10006, "4bf58dd8d48988d1e4931735": 10007, "63be6904847c3692a84b9b21": 10008, "4bf58dd8d48988d17c941735": 10009, "4bf58dd8d48988d1e5931735": 10010, "63be6904847c3692a84b9b22": 10011, "4bf58dd8d48988d1e6931735": 10012, "4bf58dd8d48988d1e7931735": 10013, "63be6904847c3692a84b9b23": 10014, "4bf58dd8d48988d1e8931735": 10015, "4bf58dd8d48988d1e9931735": 10016, "63be6904847c3692a84b9b24": 10017, "4bf58dd8d48988d1ea931735": 10018, "4bf58dd8d48988d1eb931735": 10019, "63be6904847c3692a84b9b25": 10020, "4bf58dd8d48988d1ed931735": 10021, "4bf58dd8d48988d1ef931735": 10022, "63be6904847c3692a84b9b26": 10023, "4bf58dd8d48988d1f0931735": 10024, "4bf58dd8d48988d1f1931735": 10025, "4bf58dd8d48988d1f2931735": 10026, "4bf58dd8d48988d1f3931735": 10027, "63be6904847c3692a84b9b27": 10028, "4bf58dd8d48988d1f4931735": 10029, "63be6904847c3692a84b9bb5": 13000, "4bf58dd8d48988d179941735": 13001, "4bf58dd8d48988d16a941735": 13002, "4bf58dd8d48988d116941735": 13003, "4bf58dd8d48988d1ea941735": 13004, "52e81612bcbc57f1066b7a0d": 13005, "56aa371ce4b08b9a8d57356c": 13006, "4bf58dd8d48988d117941735": 13007, "52e81612bcbc57f1066b7a0e": 13008, "4bf58dd8d48988d11e941735": 13009, "4bf58dd8d48988d118941735": 13010, "4bf58dd8d48988d1d8941735": 13011, "4bf58dd8d48988d119941735": 13012, "4bf58dd8d48988d1d5941735": 13013, "5f2c40f15b4c177b9a6dc684": 13014, "52e81612bcbc57f1066b7a06": 13015, "4bf58dd8d48988d120941735": 13016, "4bf58dd8d48988d121941735": 13017, "4bf58dd8d48988d1e8931735": 13018, "4bf58dd8d48988d11b941735": 13019, "5f2c224bb6d05514c70440a3": 13020, "4bf58dd8d48988d11c941735": 13021, "4bf58dd8d48988d1d4941735": 13022, "4bf58dd8d48988d11d941735": 13023, "56aa371be4b08b9a8d57354d": 13024, "4bf58dd8d48988d122941735": 13025, "4bf58dd8d48988d123941735": 13026, "4bf58dd8d48988d143941735": 13027, "50327c8591d4c4b30a586d5d": 13028, "63be6904847c3692a84b9bb6": 13029, "52e81612bcbc57f1066b7a0c": 13030, "4bf58dd8d48988d16d941735": 13031, "4bf58dd8d48988d1e0931735": 13032, "56aa371be4b08b9a8d573508": 13033, "4bf58dd8d48988d1dc931735": 13034, "4bf58dd8d48988d128941735": 13035, "5e189fd6eee47d000759bbfd": 13036, "52e81612bcbc57f1066b79f2": 13037, "4bf58dd8d48988d1d0941735": 13038, "4bf58dd8d48988d1bc941735": 13039, "512e7cae91d4cbb4e5efe0af": 13040, "5f2c407c5b4c177b9a6dc536": 13041, "4bf58dd8d48988d1c9941735": 13042, "5744ccdfe4b0c0459246b4e2": 13043, "52e81612bcbc57f1066b7a0a": 13044, "62d5af45da6648532de303ee": 13045, "4e0e22f5a56208c4ea9a85a0": 13046, "4bf58dd8d48988d148941735": 13047, "4bf58dd8d48988d120951735": 13048, "56aa371be4b08b9a8d57350b": 13049, "4bf58dd8d48988d1cb941735": 13050, "4bf58dd8d48988d112941735": 13051, "5e189d71eee47d000759b7e2": 13052, "53e510b7498ebcb1801b55d4": 13053, "4d4b7105d754a06374d81259": 13054, "503288ae91d4c4b30a586d67": 13055, "4bf58dd8d48988d1c8941735": 13056, "4bf58dd8d48988d10a941735": 13057, "5f2c344a5b4c177b9a6dc011": 13058, "4bf58dd8d48988d14e941735": 13059, "4bf58dd8d48988d157941735": 13060, "5f2c2b7db6d05514c7044837": 13061, "4bf58dd8d48988d142941735": 13062, "56aa371be4b08b9a8d573568": 13063, "52e81612bcbc57f1066b7a03": 13064, "4bf58dd8d48988d145941735": 13065, "4d4b7105d754a06378d81259": 17000, "5267e446e4b0ec79466e48c4": 17001, "4bf58dd8d48988d116951735": 17002, "4bf58dd8d48988d127951735": 17003, "63be6904847c3692a84b9be2": 17004, "56aa371be4b08b9a8d5734d3": 17005, "63be6904847c3692a84b9be3": 17006, "4eb1c1623b7b52c0e1adc2ec": 17007, "63be6904847c3692a84b9be4": 17008, "5e8f50bd03c7a9000c1e2fbc": 17009, "63be6904847c3692a84b9be5": 17010, "5e8f501a03c7a9000c1e2e88": 17011, "63be6904847c3692a84b9be6": 17012, "63be6904847c3692a84b9be7": 17013, "63be6904847c3692a84b9be8": 17014, "5032833091d4c4b30a586d60": 17015, "59d79d6b2e268052fa2a3332": 17016, "4bf58dd8d48988d124951735": 17017, "52f2ab2ebcbc57f1066b8b32": 17018, "52f2ab2ebcbc57f1066b8b40": 17019, "52f2ab2ebcbc57f1066b8b42": 17020, "4bf58dd8d48988d1f1941735": 17021, "4bf58dd8d48988d114951735": 17022, "52f2ab2ebcbc57f1066b8b30": 17023, "4bf58dd8d48988d104951735": 17024, "63be6904847c3692a84b9be9": 17025, "52f2ab2ebcbc57f1066b8b18": 17026, "63be6904847c3692a84b9bea": 17027, "4eb1bdf03b7b55596b4a7491": 17028, "4bf58dd8d48988d122951735": 17029, "4f04afc02fb6e1c99f3db0bc": 17030, "4bf58dd8d48988d10b951735": 17031, "5454144b498ec1f095bff2f2": 17032, "4d954b0ea243a5684a65b473": 17033, "4bf58dd8d48988d10c951735": 17034, "52f2ab2ebcbc57f1066b8b17": 17035, "63be6904847c3692a84b9beb": 17036, "4bf58dd8d48988d1f6941735": 17037, "52dea92d3cf9994f4e043dbb": 17038, "5745c2e4498e11e7bccabdbd": 17039, "589ddde98ae3635c072819ee": 17040, "4d954afda243a5684865b473": 17041, "63be6904847c3692a84b9bec": 17042, "56aa371be4b08b9a8d5734cb": 17043, "4bf58dd8d48988d11a951735": 17044, "4bf58dd8d48988d105951735": 17045, "4bf58dd8d48988d103951735": 17046, "4bf58dd8d48988d102951735": 17047, "4bf58dd8d48988d111951735": 17048, "4bf58dd8d48988d109951735": 17049, "4bf58dd8d48988d106951735": 17050, "4bf58dd8d48988d107951735": 17051, "63be6904847c3692a84b9bed": 17052, "63be6904847c3692a84b9bee": 17053, "52f2ab2ebcbc57f1066b8b2e": 17054, "4bf58dd8d48988d108951735": 17055, "503287a291d4c4b30a586d65": 17056, "52f2ab2ebcbc57f1066b8b3a": 17057, "4bf58dd8d48988d1f7941735": 17058, "56aa371be4b08b9a8d573505": 17059, "4bf58dd8d48988d11b951735": 17060, "4bf58dd8d48988d1f9941735": 17061, "5370f356bcbc57f1066c94c2": 17062, "4bf58dd8d48988d11d951735": 17063, "4bf58dd8d48988d117951735": 17064, "4bf58dd8d48988d11e951735": 17065, "52f2ab2ebcbc57f1066b8b31": 17066, "5e18993feee47d000759b256": 17067, "58daa1558bbb0b01f18ec1ca": 17068, "4bf58dd8d48988d1fa941735": 17069, "4bf58dd8d48988d10e951735": 17070, "52f2ab2ebcbc57f1066b8b1c": 17071, "4bf58dd8d48988d1f5941735": 17072, "4bf58dd8d48988d118951735": 17073, "52f2ab2ebcbc57f1066b8b45": 17074, "50aa9e744b90af0d42d5de0e": 17075, "52f2ab2ebcbc57f1066b8b2c": 17076, "5f2c41945b4c177b9a6dc7d6": 17077, "63be6904847c3692a84b9bef": 17078, "58daa1558bbb0b01f18ec1e8": 17079, "4bf58dd8d48988d186941735": 17080, "63be6904847c3692a84b9bf0": 17081, "56aa371be4b08b9a8d573564": 17082, "52f2ab2ebcbc57f1066b8b46": 17083, "58daa1558bbb0b01f18ec1e5": 17084, "4bf58dd8d48988d119951735": 17085, "52f2ab2ebcbc57f1066b8b24": 17086, "4bf58dd8d48988d1f8941735": 17087, "52f2ab2ebcbc57f1066b8b2a": 17088, "63be6904847c3692a84b9bf1": 17089, "63be6904847c3692a84b9bf2": 17090, "58daa1558bbb0b01f18ec1b4": 17091, "55888a5a498e782e3303b43a": 17092, "52f2ab2ebcbc57f1066b8b27": 17093, "4eb1c0253b7b52c0e1adc2e9": 17094, "4bf58dd8d48988d128951735": 17095, "4bf58dd8d48988d112951735": 17096, "4bf58dd8d48988d1fb941735": 17097, "52f2ab2ebcbc57f1066b8b25": 17098, "52f2ab2ebcbc57f1066b8b2b": 17099, "52f2ab2ebcbc57f1066b8b29": 17100, "55077a22498e5e9248869ba2": 19007, "5032872391d4c4b30a586d64": 19008, "4bf58dd8d48988d113951735": 19009, "4bf58dd8d48988d1f6931735": 19010, "63be6904847c3692a84b9c24": 19011, "63be6904847c3692a84b9c25": 19012, "4bf58dd8d48988d1f8931735": 19013, "4f4530a74b9074f6e4fb0100": 19014, "63be6904847c3692a84b9c26": 19015, "4bf58dd8d48988d1ee931735": 19016, "4bf58dd8d48988d1fa931735": 19017, "4bf58dd8d48988d132951735": 19018, "4bf58dd8d48988d1ec931735": 19048
};

// Helper function to convert fsq_category_id to old integer ID
function mapCategoryId(fsqCategoryId) {
    return CATEGORY_MAPPING[fsqCategoryId] || 0;
}



function fetchNearestPlace(lat, lon) {
    // Call serverless function for geotagging candidates
    const url = `/.netlify/functions/geotag?lat=${lat}&lon=${lon}&limit=3`;
    
    console.log("Making API request to:", url); // Debug logging
    
    fetch(url)
        .then(response => {
            console.log("Response status:", response.status); // Debug logging
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(payload => {
            console.log("API Response:", payload); // Debug logging
            
            // Extract the candidates from the Netlify function response structure
            const candidates = payload?.data?.candidates || [];
            
            if (candidates.length > 0) {
                let filteredResults = candidates.filter(place => {
                    return place.categories && place.categories.some(category => {
                        // Handle both old and new category format
                        let categoryId;
                        if (category.fsq_category_id) {
                            // New API format
                            categoryId = mapCategoryId(category.fsq_category_id);
                        } else if (category.id) {
                            // Old API format
                            categoryId = parseInt(category.id);
                        } else {
                            return false;
                        }
                        
                        return (categoryId >= 13000 && categoryId <= 13999) ||
                               (categoryId >= 17000 && categoryId <= 17999) ||
                               (categoryId >= 19008 && categoryId <= 19023) || 
                               (categoryId >= 19025 && categoryId <= 19030) ||
                               (categoryId >= 19034 && categoryID <= 19071);
                    });
                });

                if (filteredResults.length > 0) {
                    let nearest = filteredResults.reduce((prev, curr) => {
                        const prevDist = prev.distance || 0;
                        const currDist = curr.distance || 0;
                        return prevDist < currDist ? prev : curr;
                    });
                    
                    const distanceText = nearest.distance ? `(Distance: ${nearest.distance}m)` : '';
                    document.getElementById("nearestPlace").innerHTML = `<span style='font-size: 16px; font-weight: bold;'>${nearest.name} - ${nearest.categories[0]?.short_name || nearest.categories[0]?.name || 'Unknown Category'} ${distanceText}</span>`;
                    
                    // Handle both new and old category ID formats
                    let categoryId;
                    if (nearest.categories[0]?.fsq_category_id) {
                        categoryId = mapCategoryId(nearest.categories[0].fsq_category_id);
                    } else if (nearest.categories[0]?.id) {
                        categoryId = parseInt(nearest.categories[0].id);
                    } else {
                        categoryId = 0;
                    }
                    
                    document.getElementById("nearestPlace").dataset.categoryid = categoryId;
                    document.getElementById("screenIndicator").style.display = "block";

                    let rewardImage = document.getElementById("rewardCards");
                    rewardImage.src = categoryId % 2 === 1 ? "Top_Cards_1.PNG" : "Top_Cards_2.PNG";
                    rewardImage.style.display = "block";

                    const promo = document.getElementById("insurancePromo");
                    const promoMsg = document.getElementById("promoMessage");
                    const promoBtn = document.getElementById("promoButton");

                    if (categoryId === 19006 || categoryId === 19007 || categoryId === 19057) {
                        promoMsg.textContent = "Your next road trip could be unpredictable. Make sure your coverage isn't.";
                        document.getElementById("promoSubMessage").textContent = "";
                        promoBtn.href = "https://www.karenatessmansf.com/insurance/auto";
                        promoBtn.firstElementChild.textContent = "Get a quote";
                    } else if (categoryId % 2 === 1) {
                        promoMsg.textContent = "Get affordable life insurance in minutes";
                        document.getElementById("promoSubMessage").textContent = "Skip the medical exam, answer a few questions, and get a quick response.";
                        promoBtn.href = "https://www.karenatessmansf.com/insurance/life";
                        promoBtn.firstElementChild.textContent = "Get a quote";
                    } else {
                        promoMsg.textContent = "You're already taking care of loved ones.";
                        document.getElementById("promoSubMessage").textContent = "Let life insurance help carry the load.";
                        promoBtn.href = "https://www.karenatessmansf.com";
                        promoBtn.firstElementChild.textContent = "Learn more →";
                    }

                    promoMsg.style.display = "block";
                    promoBtn.style.display = "inline-block";
                    document.getElementById("insurancePromo").style.display = "block";

                } else {
                    document.getElementById("nearestPlace").innerText = "No nearby merchants found.";
                }
            } else {
                document.getElementById("nearestPlace").innerText = "No nearby merchants found.";
            }
        })
        .catch(error => {
            console.error("API call failed:", error);
            document.getElementById("nearestPlace").innerText = "Error fetching places. Please check your internet connection and try again.";
        });
}


// Log share events
function logShareEvent(sharerPhone, shareId) {
    // You can send this to Supabase or store locally for now
    console.log("Share event:", { sharer: sharerPhone, shareId, timestamp: new Date() });
    
    // Optional: Store in localStorage for basic tracking
    const shares = JSON.parse(localStorage.getItem('shareEvents') || '[]');
    shares.push({ sharer: sharerPhone, shareId, timestamp: new Date().toISOString() });
    localStorage.setItem('shareEvents', JSON.stringify(shares));
}

// Log when shared links are visited
function logShareVisit(referrerPhone, shareId) {
    console.log("Share visit:", { referrer: referrerPhone, shareId, timestamp: new Date() });
    
    // Optional: Store in localStorage for basic tracking
    const visits = JSON.parse(localStorage.getItem('shareVisits') || '[]');
    visits.push({ referrer: referrerPhone, shareId, timestamp: new Date().toISOString() });
    localStorage.setItem('shareVisits', JSON.stringify(visits));
}

// Share App
function shareApp() {
    // Get or generate unique user ID
    const userPhone = localStorage.getItem("userPhoneNumber") || "unknown";
    const shareId = Date.now() + Math.random().toString(36).substr(2, 5);
    
    const shareText = "This app finds your best card for rewards anywhere and it alerts you to product recalls. From State Farm agent Karen Tessman to help our community save and stay safe.";
    const baseUrl = window.location.origin + window.location.pathname;
    const shareUrl = `${baseUrl}?ref=${encodeURIComponent(userPhone)}&sid=${shareId}`;

    if (navigator.share) {
        navigator.share({
            title: "SavingsTech App",
            text: shareText,
            url: shareUrl
        });
    } else {
        window.location.href = `sms:?&body=${encodeURIComponent(shareText + " " + shareUrl)}`;
    }

    // Log the share attempt
    logShareEvent(userPhone, shareId);
}


// Show Admin Panel
function showAdminPanel() {
    // Simple password check
    const password = prompt("Enter admin password:");
    if (password !== "StateFarm") return;
    
    // Get data from localStorage instead of Supabase
    const shareEvents = JSON.parse(localStorage.getItem('shareEvents') || '[]');
    const shareVisits = JSON.parse(localStorage.getItem('shareVisits') || '[]');
    
    // Create admin display with mobile-optimized layout
    let adminHTML = `
        <div id="adminPanel" style="
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8); 
            z-index: 10000; 
            overflow: auto; 
            padding: 5px;
        ">
            <div style="
                background: white; 
                padding: 10px; 
                border-radius: 5px; 
                width: calc(100% - 10px); 
                max-height: 90%; 
                overflow: auto;
                margin-top: 20px;
            ">

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2 style="margin: 0; font-size: 16px;">Share Analytics</h2>
                <div>
                    <button onclick="clearShareData()" style="padding: 5px 8px; font-size: 12px; margin-right: 8px; background-color: #dc3545; color: white;">Clear</button>
                    <button onclick="closeAdminPanel()" style="padding: 5px 8px; font-size: 12px; margin-right: 8px;">Close</button>
                </div>
            </div>
    `;
    
    if (shareEvents.length === 0) {
        adminHTML += '<p style="text-align: center; font-size: 14px;">No sharing data available yet.</p>';
    } else {
        adminHTML += '<h3 style="font-size: 14px; margin: 10px 0 5px 0;">Share Events</h3>';
        adminHTML += `
            <table style="
                width: 100%; 
                margin-bottom: 15px; 
                border-collapse: collapse; 
                font-size: 11px;
            ">
                <tr style="background-color: #f0f0f0;">
                    <th style="padding: 4px; border: 1px solid #ddd; width: 35%;">Sharer</th>
                    <th style="padding: 4px; border: 1px solid #ddd; width: 25%;">Share ID</th>
                    <th style="padding: 4px; border: 1px solid #ddd; width: 35%;">Date</th>
                </tr>
        `;
        
        shareEvents.forEach(share => {
            const shortDate = new Date(share.timestamp).toLocaleDateString() + ' ' + 
                             new Date(share.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            adminHTML += `
                <tr>
                    <td style="padding: 4px; border: 1px solid #ddd; word-break: break-all;">${share.sharer}</td>
                    <td style="padding: 4px; border: 1px solid #ddd; word-break: break-all;">${share.shareId}</td>
                    <td style="padding: 4px; border: 1px solid #ddd;">${shortDate}</td>
                </tr>
            `;
        });
        adminHTML += '</table>';
        
        adminHTML += '<h3 style="font-size: 14px; margin: 10px 0 5px 0;">Share Visits</h3>';
        adminHTML += `
            <table style="
                width: 100%; 
                border-collapse: collapse; 
                font-size: 11px;
            ">
                <tr style="background-color: #f0f0f0;">
                    <th style="padding: 4px; border: 1px solid #ddd; width: 35%;">Referrer</th>
                    <th style="padding: 4px; border: 1px solid #ddd; width: 25%;">Share ID</th>
                    <th style="padding: 4px; border: 1px solid #ddd; width: 40%;">Visit Date</th>
                </tr>
        `;
        
        shareVisits.forEach(visit => {
            const shortDate = new Date(visit.timestamp).toLocaleDateString() + ' ' + 
                             new Date(visit.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            adminHTML += `
                <tr>
                    <td style="padding: 4px; border: 1px solid #ddd; word-break: break-all;">${visit.referrer}</td>
                    <td style="padding: 4px; border: 1px solid #ddd; word-break: break-all;">${visit.shareId}</td>
                    <td style="padding: 4px; border: 1px solid #ddd;">${shortDate}</td>
                </tr>
            `;
        });
        adminHTML += '</table>';
    }
    
    adminHTML += '</div></div>';
    
    document.body.insertAdjacentHTML('beforeend', adminHTML);
}


// Close Admin Panel
function closeAdminPanel() {
    const panel = document.getElementById('adminPanel');
    if (panel) {
        panel.remove();
    }
}

// Clear Share Data
function clearShareData() {
    const confirmation = confirm("Are you sure you want to clear all sharing data? This cannot be undone.");
    if (confirmation) {
        // Remove share data from localStorage
        localStorage.removeItem('shareEvents');
        localStorage.removeItem('shareVisits');
        
        // Close and reopen admin panel to refresh display
        closeAdminPanel();
        showAdminPanel();
        
        alert("Sharing data cleared successfully.");
    }
}


    </script>

    <div id="profileSetupScreen" class="profile-setup">
        <img src="SavingsTechpng.png" alt="App Logo" class="logo">
        <div class="mobile-box">
            <h2>Your Profile for Safety Alerts</h2>
            <p>Get notifications on what matters most</p>

            <div class="form-section">
                <label for="stateSelect">Select Your State:</label><br>
                <select id="stateSelect">
                    <option value="">--Select State--</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="DC">District of Columbia</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                    <!-- Add remaining states -->
                </select>
            </div>

            <div class="form-section checkbox-group">
                <label>Select all that apply:</label><br>
                <div class="checkbox-columns">
                    <div class="checkbox-column">
                        <input type="checkbox" id="student" name="profileType" value="Student"> Student<br>
                        <input type="checkbox" id="parent" name="profileType" value="Parent"> Parent<br>
                        <input type="checkbox" id="renter" name="profileType" value="Renter"> Renter<br>
                    </div>
                    <div class="checkbox-column">
                        <input type="checkbox" id="petowner" name="profileType" value="Pet Owner"> Pet Owner<br>
                        <input type="checkbox" id="retired" name="profileType" value="Retired"> Retired<br>
                        <input type="checkbox" id="homeowner" name="profileType" value="Homeowner"> Homeowner<br>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <label>Vehicle Information (up to 3):</label><br>
                <div id="vehicleInputs">
                    <!-- Vehicle 1 -->
                    <select class="vehicle-year" data-vehicle="0">
                        <option value="">Year</option>
                    </select>
                    <select class="vehicle-make" data-vehicle="0">
                        <option value="">Make</option>
                    </select>
                    <input type="text" class="vehicle-model" data-vehicle="0" placeholder="Model"><br>

                    <!-- Vehicle 2 -->
                    <select class="vehicle-year" data-vehicle="1">
                        <option value="">Year</option>
                    </select>
                    <select class="vehicle-make" data-vehicle="1">
                        <option value="">Make</option>
                    </select>
                    <input type="text" class="vehicle-model" data-vehicle="1" placeholder="Model"><br>

                    <!-- Vehicle 3 -->
                    <select class="vehicle-year" data-vehicle="2">
                        <option value="">Year</option>
                    </select>
                    <select class="vehicle-make" data-vehicle="2">
                        <option value="">Make</option>
                    </select>
                    <input type="text" class="vehicle-model" data-vehicle="2" placeholder="Model">
                </div>
            </div>

            <button onclick="submitProfile()">Submit</button>
            <button onclick="cancelProfile()" style="background-color: #ccc; color: #333; margin-top: 5px;">Cancel</button>

        </div>
    </div>

    <script>


function navigateTo(screen) {
    if (screen === 'profileSetup') {
        // Show profile setup screen
        document.getElementById("profileSetupScreen").style.display = "block";

        // Debug: Check if we have saved profile data
        console.log("Opening profile setup...");
        console.log("Saved profile data:", localStorage.getItem("userProfile"));

        // Load saved profile data
        setTimeout(loadSavedProfile, 100);

        // Hide ALL other screens and elements completely
        document.getElementById("sentinelScreen").style.display = "none";
        document.getElementById("maxAlertsScreen").style.display = "none";
        document.getElementById("phoneEntry").style.display = "none";
        document.getElementById("getPlaceButton").style.display = "none";
        document.getElementById("nearestPlaceHeading").style.display = "none";
        document.getElementById("output").style.display = "none";
        document.getElementById("nearestPlace").style.display = "none";
        document.getElementById("rewardCards").style.display = "none";
        document.getElementById("insurancePromo").style.display = "none";
        document.getElementById("screenIndicator").style.display = "none";

        // Hide menu during profile setup (logo stays visible)
        document.querySelector(".menu").style.display = "none";

        // Scroll to top
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
    } else if (screen === 'maxAlerts') {
        // Show Max Alerts screen
        document.getElementById("maxAlertsScreen").style.display = "block";
        document.getElementById("profileSetupScreen").style.display = "none";
        document.getElementById("sentinelScreen").style.display = "none";
        document.getElementById("phoneEntry").style.display = "none";
        document.getElementById("getPlaceButton").style.display = "none";
        document.getElementById("nearestPlaceHeading").style.display = "none";
        document.getElementById("output").style.display = "none";
        document.getElementById("nearestPlace").style.display = "none";
        document.getElementById("rewardCards").style.display = "none";
        document.getElementById("insurancePromo").style.display = "none";
        document.getElementById('barcodeFollowup').style.display = 'none';
        loadVehicleRecalls();
    } else {
        document.getElementById("profileSetupScreen").style.display = "none";
        document.getElementById("maxAlertsScreen").style.display = "none";

        // Show menu again (logo stays visible)
        document.querySelector(".menu").style.display = "block";
    }
}



        function submitProfile() {
            const state = document.getElementById("stateSelect").value;

            const checkboxes = document.querySelectorAll('input[name="profileType"]:checked');
            const profileTypes = Array.from(checkboxes).map(cb => cb.value);

            const vehicleInputs = document.querySelectorAll('#vehicleInputs input');
            const vehicles = [];
            for (let i = 0; i < 3; i++) {
                const year = document.querySelector(`.vehicle-year[data-vehicle="${i}"]`)?.value;
                const make = document.querySelector(`.vehicle-make[data-vehicle="${i}"]`)?.value;  
                const model = document.querySelector(`.vehicle-model[data-vehicle="${i}"]`)?.value;
    
                if (year || make || model) {
                    vehicles.push({ year, make, model });
                }
            }

            const profileData = {
                state,
                profileTypes,
                vehicles
            };

            localStorage.setItem("userProfile", JSON.stringify(profileData));

            alert("Profile submitted successfully!");
            console.log("Saved profile:", profileData);

            // Hide profile setup screen
            document.getElementById("profileSetupScreen").style.display = "none";
            
            // Show menu again (logo stays visible)
            document.querySelector(".menu").style.display = "block";
            
            // Show phone entry screen (login screen)
            document.getElementById("phoneEntry").style.display = "block";
            
            // Hide all other elements
            document.getElementById("getPlaceButton").style.display = "none";
            document.getElementById("nearestPlaceHeading").style.display = "none";
            document.getElementById("output").style.display = "none";
            document.getElementById("nearestPlace").style.display = "none";
            document.getElementById("rewardCards").style.display = "none";
            document.getElementById("insurancePromo").style.display = "none";
            document.getElementById("screenIndicator").style.display = "none";
            document.getElementById("sentinelScreen").style.display = "none";
            document.getElementById("maxAlertsScreen").style.display = "none";
            
            // Scroll to top
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
        }

        function cancelProfile() {
            // Hide profile setup screen
            document.getElementById("profileSetupScreen").style.display = "none";
    
            // Show menu again
            document.querySelector(".menu").style.display = "block";
    
            // Hide menu dropdown if open
            document.getElementById("menuDropdown").style.display = "none";
    
            // Return to appropriate screen based on login state
            if (localStorage.getItem("userPhoneNumber")) {
                // User is logged in - show main rewards screen
                document.getElementById("getPlaceButton").style.display = "block";
                document.getElementById("nearestPlaceHeading").style.display = "block";
                document.getElementById("output").style.display = "block";
                document.getElementById("nearestPlace").style.display = "block";
                document.getElementById("rewardCards").style.display = "block";
                document.getElementById("insurancePromo").style.display = "block";
                document.getElementById("screenIndicator").style.display = "block";
            } else {
                // User not logged in - show phone entry screen
                document.getElementById("phoneEntry").style.display = "block";
            }
    
            // Ensure other screens are hidden
            document.getElementById("sentinelScreen").style.display = "none";
            document.getElementById("maxAlertsScreen").style.display = "none";
    
            // Scroll to top
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
        }

        function loadSavedProfile() {
            const savedProfile = localStorage.getItem("userProfile");
            if (!savedProfile) {
                console.log("No saved profile found");
                return;
            }
    
            const profile = JSON.parse(savedProfile);
            console.log("Loading saved profile:", profile);
    
            // Populate state dropdown
            if (profile.state) {
                const stateSelect = document.getElementById("stateSelect");
                if (stateSelect) {
                    stateSelect.value = profile.state;
                    console.log("Set state to:", profile.state);
                }
            }
    
            // Populate checkboxes
            if (profile.profileTypes && profile.profileTypes.length > 0) {
                // First clear all checkboxes
                document.querySelectorAll('input[name="profileType"]').forEach(cb => cb.checked = false);
                // Then check the saved ones
                profile.profileTypes.forEach(type => {
                    const checkbox = document.querySelector(`input[name="profileType"][value="${type}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log("Checked:", type);
                    }
                });
            }
    
            // Populate vehicle information
            if (profile.vehicles && profile.vehicles.length > 0) {
                profile.vehicles.forEach((vehicle, index) => {
                    if (index < 3) { // Only handle up to 3 vehicles
                        const yearSelect = document.querySelector(`.vehicle-year[data-vehicle="${index}"]`);
                        const makeSelect = document.querySelector(`.vehicle-make[data-vehicle="${index}"]`);
                        const modelInput = document.querySelector(`.vehicle-model[data-vehicle="${index}"]`);
            
                        if (yearSelect && vehicle.year) yearSelect.value = vehicle.year;
                        if (makeSelect && vehicle.make) makeSelect.value = vehicle.make;
                        if (modelInput && vehicle.model) modelInput.value = vehicle.model;
                    }
                });
            }

        }

    </script>



<div id="sentinelScreen" style="display: none; text-align: center; padding: 20px;">
  <h1 style="margin-top: -25px; font-size: 20px; margin-bottom: 0px;">Max Benefits</h1>
  <p style="font-size: 15px; font-style: italic; color: #555; margin-top: 0;">Protect your card purchases</p>
  <input type="text" id="barcodeInput" placeholder="Enter 12-digit barcode" maxlength="12" style="margin-top: -10px; font-size: 16px; padding: 6px; width: 170px;"><br>
  <button onclick="lookupBarcode()" style="margin-top: 10px;">Look Up Product</button>
  <button id="scanBarcodeBtn" onclick="startScanner()" style="margin-top: 10px;">Scan for Barcode</button>
  <button id="cancelScanBtn" onclick="stopScanner()" style="display:none;">Cancel Scan</button>
  <div id="scannerContainer">
    <div id="scannerPreview" style="position: relative;">
      <div style="position: absolute; top: 40%; left: 10%; width: 80%; height: 20%; border: 2px dashed red; z-index: 10;"></div>
    </div>
  </div>
  <div id="productInfo" style="margin-top: 10px; font-size: 14px;"></div>
  <div id="barcodeFollowup" style="margin-top: -15px; font-size: 14px; display: none;">
    <!-- <p style="color: green; font-weight: bold; font-size: 11px;">No Recalls or safety alerts found</p> -->
    <p style="margin: 10px 0; font-size: 16px;">File for card purchase protection and manufacturer's warranty?</p>
    <button onclick="handleWarrantyYes()" style="display: inline-block; margin: 5px 10px; padding: 6px 12px; font-size: 17px;">Yes</button>
    <button onclick="handleWarrantyNo()" style="display: inline-block; margin: 5px 10px; padding: 6px 12px; font-size: 17px;">No</button>
    <div style="margin-top: 20px;">
      <p style="font-size: 15px; font-style: italic; color: #0070C0; margin-bottom: 10px;">
        Protect all your belongings with low cost renters and home insurance
      </p>
      <a href="https://karenatessmansf.com/insurance/homeowners" target="_blank" style="text-decoration: none;">
        <button style="margin-top: 5px; padding: 6px 14px; font-size: 16px;">Get a quote</button>
      </a>
    </div>
  </div>
</div>
<script>
function showSentinelScreen() {
  document.getElementById("dotTopCard").textContent = "○";
  document.getElementById("dotTopCard").style.color = "#ccc";
  document.getElementById("dotSentinel").textContent = "●";
  document.getElementById("dotSentinel").style.color = "#0070C0";  
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
  document.getElementById("sentinelScreen").style.display = "block";
  document.getElementById("phoneEntry").style.display = "none";
  document.getElementById("getPlaceButton").style.display = "none";
  document.getElementById("nearestPlaceHeading").style.display = "none";
  document.getElementById("output").style.display = "none";
  document.getElementById("nearestPlace").style.display = "none";
  document.getElementById("rewardCards").style.display = "none";
  document.getElementById("insurancePromo").style.display = "none";
  document.getElementById("maxAlertsScreen").style.display = "none";
}

function showMaxAlertsScreen() {
  document.getElementById("dotTopCard").textContent = "○";
  document.getElementById("dotTopCard").style.color = "#ccc";
  document.getElementById("dotSentinel").textContent = "○";
  document.getElementById("dotSentinel").style.color = "#ccc";
  document.getElementById("dotMaxAlerts").textContent = "●";
  document.getElementById("dotMaxAlerts").style.color = "#0070C0";
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
  document.getElementById("maxAlertsScreen").style.display = "block";
  document.getElementById("sentinelScreen").style.display = "none";
  document.getElementById("phoneEntry").style.display = "none";
  document.getElementById("getPlaceButton").style.display = "none";
  document.getElementById("nearestPlaceHeading").style.display = "none";
  document.getElementById("output").style.display = "none";
  document.getElementById("nearestPlace").style.display = "none";
  document.getElementById("rewardCards").style.display = "none";
  document.getElementById("insurancePromo").style.display = "none";
  loadVehicleRecalls();
}

function showMaxRewardsScreen() {
  document.getElementById("dotTopCard").textContent = "●";
  document.getElementById("dotTopCard").style.color = "#0070C0";
  document.getElementById("dotSentinel").textContent = "○";
  document.getElementById("dotSentinel").style.color = "#ccc";
  document.getElementById("dotMaxAlerts").textContent = "○";
  document.getElementById("dotMaxAlerts").style.color = "#ccc";
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
  document.getElementById("maxAlertsScreen").style.display = "none";
  document.getElementById("sentinelScreen").style.display = "none";
  document.getElementById("phoneEntry").style.display = "none";
  document.getElementById("getPlaceButton").style.display = "block";
  document.getElementById("nearestPlaceHeading").style.display = "block";
  document.getElementById("output").style.display = "block";
  document.getElementById("nearestPlace").style.display = "block";
  document.getElementById("rewardCards").style.display = "block";
  document.getElementById("insurancePromo").style.display = "block";
}

function handleBenefitsResponse(response) {
  if (response === 'yes' || response === 'no') {
    document.getElementById("insurancePromo").style.display = "block";
  }
}


function lookupBarcode(upcOverride) {
   const barcode = upcOverride || document.getElementById("barcodeInput").value;
   if (barcode.length !== 12) {
     alert("Please enter a valid 12-digit barcode.");
     return;
   }
  const url = `/.netlify/functions/barcode?barcode=${barcode}`;
  fetch(url)
    .then(res => res.json())
    .then(data => {
      console.log("API response:", data);
      if (!data.products || !data.products.length) {
        document.getElementById("productInfo").innerHTML = "Product not found";
        document.getElementById('barcodeFollowup').style.display = 'none';
        // Clear Max Alerts product info if no product found
        document.getElementById("maxAlertsProductInfo").innerHTML = "";
        return;
      }
      const product = data.products[0];
      const image = product.images && product.images.length > 0 ? product.images[0] : "";
      const info = `
        <strong>Manufacturer:</strong> ${product.manufacturer || 'N/A'}<br>
        <strong>Brand:</strong> ${product.brand || 'N/A'}<br>
        <strong>Model:</strong> ${product.model || 'N/A'}
        <strong>   Category:</strong> ${product.category || 'N/A'}<br>
        ${image ? `<img src="${image}" alt="Product Image" style="width: 100px; margin-top: 5px;">` : ""}`;
      document.getElementById("productInfo").innerHTML = info;
      document.getElementById('barcodeFollowup').style.display = 'block';

      // Update Max Alerts screen product info
      updateMaxAlertsProductInfo(product, barcode, image);

    })
    .catch(error => {
      console.error("Error fetching barcode data:", error);
      document.getElementById("productInfo").innerHTML = "Product not found.";
      document.getElementById('barcodeFollowup').style.display = 'none';
      document.getElementById("maxAlertsProductInfo").innerHTML = "";
    });
}

function updateMaxAlertsProductInfo(product, barcode, image) {
  const maxAlertsContainer = document.getElementById("maxAlertsProductInfo");
  
  // Product display section
  const productDisplay = document.createElement("div");
  productDisplay.className = "product-display";
  
  let productHTML = "";
  if (image) {
    productHTML += `<img src="${image}" alt="Product Image" class="product-image">`;
  } else {
    productHTML += `<div class="product-image" style="background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666;">No Image</div>`;
  }
  
  productHTML += `
    <div class="product-details">
      <strong>Brand:</strong> ${product.brand || 'N/A'}<br>
      <strong>Model:</strong> ${product.model || 'N/A'}<br>
      <strong>UPC:</strong> ${barcode}
    </div>
  `;
  
  productDisplay.innerHTML = productHTML;
  productDisplay.style.marginBottom = "0px";
  
  // Recall status section
  const recallStatus = document.createElement("div");
  recallStatus.style.marginTop = "0px";
  
  if (barcode === "706943534113") {
    recallStatus.innerHTML = `
      <p style="color: red; font-size: 14px; font-weight: bold; margin: 0 0 20px 0;">Backyard Kids Recalls KidKraft Farm to Table Play Kitchens Due to Strangulation Hazard; One Death Reported. CPSC reported July 31, 2025.</p>
      <div style="margin: 10px 0;">
        <span style="background-color: yellow; color: black; padding: 2px 6px; font-size: 12px;">Injuries Reported</span>
        <span style="margin-left: 25px; background-color: red; color: white; padding: 2px 6px; font-size: 12px;">Death(s) reported</span>
      </div>
    `;
  } else {
    recallStatus.innerHTML = `<p style="color: green; font-size: 14px; font-weight: bold; margin: 0 0 20px 0;">No recalls or safety alerts found.</p>`;
  }


  maxAlertsContainer.innerHTML = "";
  maxAlertsContainer.appendChild(productDisplay);
  maxAlertsContainer.appendChild(recallStatus);
}

function startScanner() {
  document.getElementById('scannerContainer').style.display = 'block';
  document.getElementById('cancelScanBtn').style.display = 'inline';
  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: document.querySelector('#scannerPreview'),
      constraints: {
        facingMode: { exact: "environment" },
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    },
    decoder: {
      readers: ["upc_reader"],
      debug: {
        drawBoundingBox: false,
        showFrequency: false,
        drawScanline: false,
        showPattern: false
      }
    },
    locator: {
      patchSize: "medium",
      halfSample: true
    },
    numOfWorkers: navigator.hardwareConcurrency || 4,
    frequency: 5
  }, function(err) {
    if (err) {
      console.error(err);
      return;
    }
    Quagga.start();
  });

  Quagga.onDetected(onBarcodeDetected);
}

function stopScanner() {
  Quagga.stop();
  Quagga.offDetected(onBarcodeDetected);
  document.getElementById('scannerContainer').style.display = 'none';
  document.getElementById('cancelScanBtn').style.display = 'none';
}

function onBarcodeDetected(result) {
  const code = result.codeResult.code;
  if (/^\d{12}$/.test(code)) {
    document.getElementById("beepSound").play();
    stopScanner();
    document.getElementById('barcodeInput').value = code;
    lookupBarcode(code);
  }
}

async function checkRecall(barcode) {
    const resultDiv = document.getElementById("recallResult");
    resultDiv.innerText = "";

    try {
        const response = await fetch(`https://www.saferproducts.gov/RestWebServices/Recall?format=json&UPC=${barcode}`);
        const data = await response.json();

        if (data && data.length > 0 && data[0].Title) {
            resultDiv.innerText = data[0].Title;
            resultDiv.style.color = "red";
        } else {
            resultDiv.innerText = "";
            resultDiv.style.color = "green";
        }
    } catch (error) {
        console.error("Recall API error:", error);
        resultDiv.innerText = "Unable to check recall information.";
        resultDiv.style.color = "orange";
    }
}

function handleWarrantyYes() {
    alert("You selected Yes. Further logic to be implemented.");
}

function handleWarrantyNo() {
    document.getElementById('barcodeFollowup').style.display = 'none';
}

// FIXED: Single unified touch handler to manage all three screens
let xStart = null;
let yStart = null;

function handleTouchStart(evt) {
  // Don't handle touch events when profile setup is visible
  if (document.getElementById("profileSetupScreen").style.display === "block") {
    return;
  }
  
  xStart = evt.touches[0].clientX;
  yStart = evt.touches[0].clientY;
}

function handleTouchEnd(evt) {
  // Don't handle touch events when profile setup is visible
  if (document.getElementById("profileSetupScreen").style.display === "block") {
    return;
  }
  
  if (!xStart || !yStart) return;
  
  let xEnd = evt.changedTouches[0].clientX;
  let yEnd = evt.changedTouches[0].clientY;
  let xDiff = xStart - xEnd;
  let yDiff = yStart - yEnd;
  
  // Only handle horizontal swipes (ignore if vertical swipe is larger)
  if (Math.abs(yDiff) > Math.abs(xDiff)) {
    xStart = null;
    yStart = null;
    return;
  }

  const isMaxRewardsVisible = document.getElementById("nearestPlaceHeading").style.display === "block";
  const isSentinelVisible = document.getElementById("sentinelScreen").style.display === "block";
  const isMaxAlertsVisible = document.getElementById("maxAlertsScreen").style.display === "block";

  if (xDiff > 50) {
    if (isMaxRewardsVisible) {
      showSentinelScreen();
    } else if (isSentinelVisible) {
      showMaxAlertsScreen();
    }
  } else if (xDiff < -50) {
    if (isMaxAlertsVisible) {
      showSentinelScreen();
    } else if (isSentinelVisible) {
      showMaxRewardsScreen();
    }
  }
  
  xStart = null;
  yStart = null;
}

document.addEventListener('touchstart', handleTouchStart, false);
document.addEventListener('touchend', handleTouchEnd, false);

</script>


<div id="maxAlertsScreen" style="display: none; text-align: center; padding: 0px;">
    <h1 style="margin-top: 0px; font-size: 20px; margin-bottom: 0px;">Max Alerts</h1>
    <p style="font-size: 15px; font-style: italic; color: #555; margin-top: 0;">Updates on recalls and safety alerts</p>
    <p style="font-size: 17px; text-align: left; font-weight: bold; color: #0070C0; margin-top: 0; margin-bottom: 0px;">Updates on recent purchases</p>
    <div id="maxAlertsProductInfo" style="margin: 15px 0; text-align: left; margin-top: 0; margin-bottom: 0px;"></div>
    <div id="alertsContainer" style="text-align: left; margin-top: 0; margin-bottom: 0px;"></div>
</div>

<script>

    // Helper function to parse DD/MM/YYYY format and convert to MM/DD/YYYY display format
    function parseDateFromDDMMYYYY(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split('/');
        if (parts.length !== 3) return null;
        const day = parts[0];
        const month = parts[1];
        const year = parts[2];
        // Return date object using MM/DD/YYYY format for proper parsing
        return new Date(month + '/' + day + '/' + year);
    }

    function formatDateToMMDDYYYY(dateStr) {
        if (!dateStr) return dateStr;
        const parts = dateStr.split('/');
        if (parts.length !== 3) return dateStr;
        const day = parts[0];
        const month = parts[1];
        const year = parts[2];
        // Convert DD/MM/YYYY to MM/DD/YYYY for display
        return month + '/' + day + '/' + year;
    }

    async function loadVehicleRecalls() {
        const profile = JSON.parse(localStorage.getItem("userProfile"));
        const container = document.getElementById("alertsContainer");
        
        // Add heading for profile-based recalls
        let heading = "<p style='font-size: 17px; text-align: left; font-weight: bold; color: #0070C0; margin-top: 0; margin-bottom: 5px;'>Updates based on profile</p>";
          
        if (!profile || !profile.vehicles || profile.vehicles.length === 0) {
            container.innerHTML = heading + "<p>There are no vehicles set up in your profile.</p>";
            return;
        }

        container.innerHTML = heading;

        for (const vehicle of profile.vehicles) {
            const { year, make, model } = vehicle;
            if (!(year && make && model)) continue;
            try {
                const response = await fetch(`https://api.nhtsa.gov/recalls/recallsByVehicle?make=${make}&model=${model}&modelYear=${year}`);
                const data = await response.json();

                const recalls = (data.results || []).filter(r => {
                    const reportDate = parseDateFromDDMMYYYY(r.ReportReceivedDate);
                    if (!reportDate) return false;
                    const now = new Date();
                    return reportDate > new Date(now.getFullYear() - 4, now.getMonth(), now.getDate());
                }).sort((a, b) => {
                    // Sort by date, most recent first
                    const dateA = parseDateFromDDMMYYYY(a.ReportReceivedDate);
                    const dateB = parseDateFromDDMMYYYY(b.ReportReceivedDate);
                    return dateB - dateA;
                }).slice(0, 3);

                if (recalls.length > 0) {
                    const section = document.createElement("div");
                    section.className = "recall-detail";
                    section.innerHTML = `<div class='recall-heading'><strong>${year} ${make} ${model}</strong></div>
                        <div><strong>${recalls.length} recalls</strong></div>`;


                    recalls.forEach(r => {
                        const formattedDate = formatDateToMMDDYYYY(r.ReportReceivedDate);
                        section.innerHTML += `
                            <div>${formattedDate}</div>
                            <div>
                                <strong>Do Not Drive:</strong> ${r.ParkIt ? 'Yes' : 'No'}<br>
                                <strong>Must park outside:</strong> ${r.ParkOutside ? 'Yes' : 'No'}<br>
                                <strong>Over-the-Air Update:</strong> ${r.OTAUpdate ? 'Yes' : 'No'}
                            </div>
                            <div><strong>Summary:</strong> ${r.Summary}</div>
                            <div><strong>Remedy:</strong> ${r.Remedy}</div>
                            <hr>
                        `;
                    });
                    container.appendChild(section);
                }
            } catch (e) {
                console.error("Recall fetch error:", e);
            }
        }
    }
</script>


<div id="swipeHint" style="display: none; position: fixed; top: 50%; right: 10px; transform: translateY(-50%); z-index: 999;">
  <img src="arrow_right_icon.png" alt="Swipe Right" style="width: 40px; height: 40px; opacity: 0.7;">
</div>
<div id="screenIndicator" style="position: fixed; bottom: 8px; left: 50%; transform: translateX(-50%); display: none; z-index: 999;">
  <span id="dotTopCard" style="font-size: 24px; color: #0070C0;">●</span>
  <span id="dotSentinel" style="font-size: 24px; color: #ccc;">○</span>
  <span id="dotMaxAlerts" style="font-size: 24px; color: #ccc;">○</span>
</div>
</body>
</html>